<!DOCTYPE html>
<html>

<head>
    <title>Backyard Chickens</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"> </script>
    <script>
        $(document).ready(function(){
            //Set up button click handler for the search form:
            $("button").click(function(){
                // Get the person's entered address
                var input = document.getElementById("address").value;
                // Convert the address into the right format for the OpenStreetMaps search
                var spacesReplaced = input.replace(" ", "%20");
                // Send the user's address to OpenStreetMaps and get the returned city
                var searchURL = "https://nominatim.openstreetmap.org/search/" + input + "?format=json&addressdetails=1&limit=1&polygon_svg=1";
                console.log(searchURL);
                $.post(searchURL,
                function (data) {
                    console.log(data);
                    var city = data[0].address.city;
                    //console.log(city);
                    document.getElementById("result").innerHTML = " is in "+city;
                    //Update info bubble on map:
                    showCity(L.latLng(data[0].lat,data[0].lon));
                    //^^this ungodly hack works because it can only get run after the body script tag initializes showCity
                });
            });
        });

    </script>
</head>

<body>
    <form>
        <input type="text" id="address">
        <div id="result" style="display:inline"></div>
    </form> 
    <button>Send</button>
    <div id="mapid" style="width: 600px; height: 400px;"></div>
    <script>
        //Set up map:
        var mymap = L.map('mapid').setView([38.66085, -90.362549], 11);


        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(mymap);

        //Initialize popup object to show information on the map:
        var popup = L.popup();

        //Show city at coordinates:
        function showCity(coords)
        {
            //Send the coordinates to OpenStreetMaps and get the returned city:
            var queryURL = "https://nominatim.openstreetmap.org/reverse?format=json&lat="+coords.lat+"&lon="+coords.lng+"&zoom=18&addressdetails=1";
            var xHR = new XMLHttpRequest();
            xHR.addEventListener("load", function () {
                //Display result on the map:
                //console.log(xHR.responseText);
                address=JSON.parse(xHR.responseText).address;
                popup.setContent("You are in "+address.city+".");
                popup.setLatLng(coords);
                popup.openOn(mymap);
                //console.log(address.city);
            });
            xHR.open("GET", queryURL);
            xHR.send();
            //(I don't usually like using extra libraries like jQuery.)
        }

        //Set up handler function for click events:
        function onMapClick(e) {
            /*
            //Example code:
            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString())
                .openOn(mymap);
            */

            //Get containing city and display it on the map:
            showCity(e.latlng);
        }

        mymap.on('click', onMapClick);
        
    </script>
</body>

</html>